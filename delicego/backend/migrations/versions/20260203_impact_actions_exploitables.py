"""feat: impact actions exploitables (assignee/due_date/priority/updated_at)

Revision ID: 20260203_impact_actions_exploitables
Revises: cb98e890d546
Create Date: 2026-02-03

"""

from __future__ import annotations

import sqlalchemy as sa
from alembic import op


# revision identifiers, used by Alembic.
revision = "20260203_impact_actions_exploitables"
down_revision = "20260203_expand_alembic_version_num"
branch_labels = None
depends_on = None


def _col_exists(table_name: str, column_name: str) -> bool:
    bind = op.get_bind()
    # Offline mode uses a SQLAlchemy MockConnection (no inspection available).
    # This migration is purely schema-level; in offline we just emit the ADD COLUMN
    # statements unconditionally (and duplicates would fail anyway), so we avoid
    # inspection.
    if bind.dialect.name == "postgresql" and bind.__class__.__name__ == "MockConnection":
        return False

    insp = sa.inspect(bind)
    try:
        cols = [c["name"] for c in insp.get_columns(table_name)]
    except Exception as e:
        # If the table is missing, the migration chain is broken (this migration
        # must run after the one that creates `impact_action`).
        raise RuntimeError(
            "impact_action missing, migration order broken: "
            "expected table 'impact_action' to exist before adding columns"
        ) from e
    return column_name in set(cols)


def upgrade() -> None:
    # IMPORTANT:
    # Base neuve: les tables impact n'existaient pas dans l'historique Alembic.
    # On les crÃ©e ici pour garantir que `alembic upgrade head` passe sur DB vide.

    op.create_table(
        "impact_recommendation_event",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("code", sa.String(length=120), nullable=False),
        sa.Column("metric", sa.String(length=120), nullable=False),
        sa.Column("entities_signature", sa.String(length=64), nullable=False),
        sa.Column("severity", sa.String(length=20), nullable=False),
        sa.Column("status", sa.String(length=20), nullable=False),
        sa.Column("entities", sa.dialects.postgresql.JSONB(astext_type=sa.Text()), nullable=True),
        sa.Column("first_seen_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("last_seen_at", sa.DateTime(timezone=True), nullable=False),
        sa.Column("occurrences", sa.Integer(), nullable=False),
        sa.Column("resolved_at", sa.DateTime(timezone=True), nullable=True),
        sa.Column("comment", sa.String(length=500), nullable=True),
        sa.Column("cree_le", sa.DateTime(timezone=True), server_default=sa.text("now()"), nullable=False),
        sa.Column("mis_a_jour_le", sa.DateTime(timezone=True), server_default=sa.text("now()"), nullable=False),
        sa.PrimaryKeyConstraint("id"),
    )

    op.create_table(
        "impact_action",
        sa.Column("id", sa.UUID(), nullable=False),
        sa.Column("recommendation_event_id", sa.UUID(), nullable=False),
        sa.Column("action_type", sa.String(length=50), nullable=False),
        sa.Column("description", sa.String(), nullable=True),
        sa.Column("created_by", sa.String(length=120), nullable=True),
        sa.Column("expected_impact", sa.dialects.postgresql.JSONB(astext_type=sa.Text()), nullable=True),
        sa.Column("status", sa.String(length=20), nullable=False),
        sa.Column("assignee", sa.String(length=120), nullable=True),
        sa.Column("due_date", sa.Date(), nullable=True),
        sa.Column("priority", sa.SmallInteger(), nullable=True),
        sa.Column("updated_at", sa.DateTime(timezone=True), server_default=sa.text("now()"), nullable=False),
        sa.Column("cree_le", sa.DateTime(timezone=True), server_default=sa.text("now()"), nullable=False),
        sa.Column("mis_a_jour_le", sa.DateTime(timezone=True), server_default=sa.text("now()"), nullable=False),
        sa.ForeignKeyConstraint(
            ["recommendation_event_id"],
            ["impact_recommendation_event.id"],
            name="fk_impact_action_recommendation_event_id",
            ondelete="CASCADE",
        ),
        sa.PrimaryKeyConstraint("id"),
    )

    op.create_index(
        "ix_impact_action_recommendation_event_id",
        "impact_action",
        ["recommendation_event_id"],
        unique=False,
    )
    op.create_index("ix_impact_action_status", "impact_action", ["status"], unique=False)
    op.create_index("ix_impact_recommendation_event_code", "impact_recommendation_event", ["code"], unique=False)
    op.create_index(
        "ix_impact_recommendation_event_status",
        "impact_recommendation_event",
        ["status"],
        unique=False,
    )


def downgrade() -> None:
    # best-effort (downgrade non-idempotent by nature)
    with op.batch_alter_table("impact_action") as batch:
        for col in ["updated_at", "priority", "due_date", "assignee"]:
            try:
                batch.drop_column(col)
            except Exception:
                # column may not exist depending on environment
                pass
