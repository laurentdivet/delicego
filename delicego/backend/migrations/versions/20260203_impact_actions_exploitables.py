"""feat: impact actions exploitables (assignee/due_date/priority/updated_at)

Revision ID: 20260203_impact_actions_exploitables
Revises: cb98e890d546
Create Date: 2026-02-03

"""

from __future__ import annotations

import sqlalchemy as sa
from alembic import op


# revision identifiers, used by Alembic.
revision = "20260203_impact_actions_exploitables"
down_revision = "cb98e890d546"
branch_labels = None
depends_on = None


def _col_exists(table_name: str, column_name: str) -> bool:
    bind = op.get_bind()
    insp = sa.inspect(bind)
    cols = [c["name"] for c in insp.get_columns(table_name)]
    return column_name in set(cols)


def upgrade() -> None:
    # Idempotent-ish: check column presence before adding.
    if not _col_exists("impact_action", "assignee"):
        op.add_column("impact_action", sa.Column("assignee", sa.String(length=120), nullable=True))

    if not _col_exists("impact_action", "due_date"):
        op.add_column("impact_action", sa.Column("due_date", sa.Date(), nullable=True))

    if not _col_exists("impact_action", "priority"):
        op.add_column("impact_action", sa.Column("priority", sa.SmallInteger(), nullable=True))

    if not _col_exists("impact_action", "updated_at"):
        op.add_column(
            "impact_action",
            sa.Column(
                "updated_at",
                sa.DateTime(timezone=True),
                nullable=False,
                server_default=sa.text("now()"),
            ),
        )


def downgrade() -> None:
    # best-effort (downgrade non-idempotent by nature)
    with op.batch_alter_table("impact_action") as batch:
        for col in ["updated_at", "priority", "due_date", "assignee"]:
            try:
                batch.drop_column(col)
            except Exception:
                # column may not exist depending on environment
                pass
